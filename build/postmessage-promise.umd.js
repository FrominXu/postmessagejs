!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).postMessagePromise={})}(this,(function(e){"use strict";function n(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function t(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var s="client_response",i="server_response",a={server:{receive:s,post:i},client:{receive:i,post:s}},c=["hand-shake","wave-hand",s,i],l=r((function e(t,r,s){var i=this;o(this,e),n(this,"receiveMessage",(function(e,n,t){if(e===a[i.type].receive){if(n&&i.messageResponse[n]){var r=i.messageResponse[n];delete i.messageResponse[n],r(t)}}else if(i.listener){i.listener(e,t,(function(e){i.messageProxy.request(a[i.type].post,n,e)}))}else console.warn("no message listener: ",e,t)})),n(this,"doPost",(function(e,n,t){var r=e.resolve,o=e.reject,s=e.eventId;i.messageResponse[s]=r;try{i.messageProxy.request(n,s,t)}catch(e){throw delete i.messageResponse[s],o(),e}})),n(this,"listenMessage",(function(e){i.listener=e})),n(this,"postMessage",(function(e,n){return c.indexOf(e)>=0?Promise.reject(new Error("".concat(e," is a protected key-method."))):new Promise((function(t,r){if(i.destroyed)r(new Error("message-channel had been destroyed!"));else{var o=null,s=Math.random().toString().substr(3,10);i.doPost({resolve:function(e){clearTimeout(o),t(e)},reject:r,eventId:s},e,n),o=setTimeout((function(){i.messageResponse&&delete i.messageResponse[s],r(new Error("postMessage timeout"))}),i.timeout||2e4)}}))})),n(this,"destroy",(function(){i.destroyed=!0,i.unListen&&(i.unListen(),i.unListen=null),i.listener=null,i.messageResponse=null,i.messageProxy&&(i.messageProxy.destroy(),i.messageProxy=null)})),this.type=t,this.messageProxy=r,this.listener=null,this.messageResponse={},this.timeout=s,this.unListen=this.messageProxy.listen(this.receiveMessage)})),u="postmessage-promise_client",d="postmessage-promise_server",f="identity_key",v={server:{key:d,accept:u},client:{key:u,accept:d}},h=r((function e(t,r,s){var i=this;o(this,e),n(this,"listen",(function(e){var n=i,t=function(t){if(("*"===n.origin||t.origin===n.origin)&&t.source===n.source&&t.data&&t.data[f]===v[n.type].accept&&t.data.channelId===n.channelId&&n.eventFilter(t)&&t.data.method){var r=t.data,o=r.eventId,s=r.method,i=r.payload;e(s,o,i)}};return window.addEventListener("message",t),function(){window.removeEventListener("message",t)}})),n(this,"request",(function(e,t,r){i.source&&!i.source.closed?i.source.postMessage(n(n(n(n(n({},f,v[i.type].key),"channelId",i.channelId),"eventId",t),"method",e),"payload",r),i.origin):console.error("source closed.")})),n(this,"destroy",(function(){i.type="",i.origin="",i.source=null,i.channelId="",i.eventFilter=null})),this.type=t;var a=r.origin,c=r.source,l=r.channelId;this.origin=a,this.source=c,this.channelId=l,this.eventFilter=s}));function p(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function m(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?p(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):p(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function g(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)throw new Error("serverObject is null");var t=e.server,r=e.origin,o=n.eventFilter,s=void 0===o?function(){return!0}:o,i=n.timeout,a=void 0===i?2e4:i,c=n.clientInfo,u=void 0===c?{}:c,d=n.onDestroy,f=Math.random().toString().substr(3,10),v={source:t,origin:r,channelId:f};return new Promise((function(e,n){if(t&&!t.closed){var r=new h("client",v,s);(function(e,n,t,r){return new Promise((function(o,s){var i=e.source,a=e.origin,c=e.channelId,l=Number(Math.random().toString().substr(3,10)),u=null,d=new Date,f=null;f=n.listen((function(e,t){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("hand-shake"===e){var d=s||{},v=d.SYN,h=d.ACK,p=d.seqnumber,m=d.acknumber;1===v&&1===h&&m===l+1&&(clearInterval(u),f&&f(),n.request("hand-shake","hand-shake-event",{clientInfo:r,ACK:1,seqnumber:l+1,acknumber:p+1}),o({server:i,origin:a,channelId:c,serverInfo:s.serverInfo,clientInfo:r}))}})),u=setInterval((function(){if(!i||i.closed)throw clearInterval(u),f&&f(),s(new Error("server closed.")),new Error("server closed.");if(t&&new Date-d>t)throw clearInterval(u),f&&f(),s(new Error("connect timeout.")),new Error("connect timeout.");n.request("hand-shake","hand-shake-event",{clientInfo:r,SYN:1,ACK:0,seqnumber:l})}),100)}))})(v,r,a,u).then((function(n){(function(e,n,t){var r=e.server,o=e.serverInfo,s=void 0===o?{}:o,i=e.channelId,a=new l("client",n,t),c=function(){a&&(a.destroy(),a=null),e.destroy&&e.destroy()},u=null;return u=setInterval((function(){r&&!r.closed||(console.info("server closed."),clearInterval(u),c())}),2e3),{run:function(e){e({channelId:i,serverInfo:s,postMessage:function(){var e;return a?(e=a).postMessage.apply(e,arguments):Promise.reject()},listenMessage:function(){var e;a&&(e=a).listenMessage.apply(e,arguments)},destroy:c})}}})(m(m({},n),{},{destroy:function(){r=null,d&&d(n.serverInfo,n)}}),r,a).run(e)})).catch((function(e){n(e)}))}else n(new Error("server closed"))}))}function y(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?y(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):y(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}var w="postmessage-promise_client",I="identity_key",O=1e3,P=5;function j(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.eventFilter,r=void 0===t?function(){return!0}:t,o=e.timeout,s=void 0===o?2e4:o,i=e.serverInfo,a=void 0===i?{}:i,c=e.onDestroy;return new Promise((function(e){(function(e,t){return new Promise((function(r){var o="syn",s=Number(Math.random().toString().substr(3,10)),i=-1,a=null,c=P;window.addEventListener("message",(function l(u){if(u.data&&u.data[I]===w&&u.data.channelId&&u.data.method&&"hand-shake"===u.data.method&&e(u)){var d=u.data.payload||{},f=d.SYN,v=d.ACK,h=d.seqnumber,p=d.acknumber;if(1===f&&0===v){if("syn"!==o)return;i=h,o="ack";var m=function(){if(!u.source||u.source.closed)return console.info("client closed and reset to listening."),o="syn",clearTimeout(a),a=null,c=P,s=Number(Math.random().toString().substr(3,10)),i=-1,!1;try{u.source.postMessage(n(n(n(n({},I,"postmessage-promise_server"),"channelId",u.data.channelId),"method","hand-shake"),"payload",{serverInfo:t,acknumber:h+1,SYN:1,ACK:1,seqnumber:s}),u.origin)}catch(e){return console.error(e),!0}return!0};if(!m())return;a||(a=setTimeout((function e(){c>0?"ack"===o&&(c-=1,m()&&(a=setTimeout(e,O))):(console.info("server three-way hand shake timeout and reset to listening."),o="syn",clearTimeout(a),a=null,c=P,s=Number(Math.random().toString().substr(3,10)),i=-1)}),O))}else if("ack"===o&&1===v&&h===i+1&&p===s+1){o="finish",clearTimeout(a),a=null,window.removeEventListener("message",l);var g=u.data.payload,y=void 0===g?{}:g;r({client:u.source,origin:u.origin,channelId:u.data.channelId,serverInfo:t,clientInfo:y.clientInfo})}}}))}))})(r,a).then((function(n){(function(e,n,t){var r=e.origin,o=e.client,s=e.channelId,i=e.clientInfo,a=void 0===i?{}:i,c=new h("server",{origin:r,source:o,channelId:s},n),u=new l("server",c,t),d=function(){u&&(u.destroy(),u=null),c=null,e.destroy&&e.destroy()},f=null;return f=setInterval((function(){o&&!o.closed||(console.info("client closed."),clearInterval(f),d())}),2e3),{run:function(e){e({channelId:s,clientInfo:a,postMessage:function(){var e;return u?(e=u).postMessage.apply(e,arguments):Promise.reject()},listenMessage:function(){var e;u&&(e=u).listenMessage.apply(e,arguments)},destroy:d})}}})(b(b({},n),{},{destroy:function(){c&&c(n.clientInfo,n)}}),r,s).run(e)}))}))}function k(e){var n=document.createElement("a");n.href=e;var t=n.protocol.length>4?n.protocol:window.location.protocol,r=n.host.length?"80"===n.port||"443"===n.port?n.hostname:n.host:window.location.host;return n.origin||"".concat(t,"//").concat(r)}var M={resolveOrigin:k,getIframeServer:function(e,n,t){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=void 0!==e?e:document.body,s=k(n),i=document.createElement("iframe");return i.name=t||"",i.classList.add.apply(i.classList,r),o.appendChild(i),i.src=n,{server:i.contentWindow||i.contentDocument.parentWindow,origin:s,frame:i}},getOpenedServer:function(e){for(var n,t=k(e),r=arguments.length,o=new Array(r>1?r-1:0),s=1;s<r;s++)o[s-1]=arguments[s];return{server:(n=window).open.apply(n,[e].concat(o)),origin:t}}},E={callServer:g,startListening:j,utils:M};e.callServer=g,e.default=E,e.startListening=j,e.utils=M,Object.defineProperty(e,"__esModule",{value:!0})}));
